cat bench/tpch-q5-sqlite-prep.sql bench/tpch-q5-sqlite.sql | sed 's#TPC-H\.db#TPC-H-x0.05.db#g' | sqlite3/shell

CREATE TABLE REGION  ( R_REGIONKEY  INTEGER NOT NULL,
                            R_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (R_REGIONKEY));
CREATE TABLE NATION  ( N_NATIONKEY  INTEGER NOT NULL,
                            N_REGIONKEY  INTEGER NOT NULL REFERENCES REGION (R_REGIONKEY),
                            N_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (N_NATIONKEY));
CREATE TABLE SUPPLIER ( S_SUPPKEY     INTEGER NOT NULL,
                             S_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (S_SUPPKEY));
CREATE TABLE CUSTOMER ( C_CUSTKEY     INTEGER NOT NULL,
                             C_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (C_CUSTKEY));
CREATE TABLE ORDERS  ( O_ORDERKEY       INTEGER NOT NULL,
                           O_CUSTKEY        INTEGER NOT NULL REFERENCES CUSTOMER (C_CUSTKEY),
                           O_ORDERDATE      DATE NOT NULL,
                           PRIMARY KEY (O_ORDERKEY));
CREATE TABLE LINEITEM ( L_ORDERKEY    INTEGER NOT NULL REFERENCES SUPPLIER (O_ORDERKEY),
                             L_SUPPKEY     INTEGER NOT NULL REFERENCES SUPPLIER (S_SUPPKEY),
                             L_LINENUMBER  INTEGER NOT NULL,
                             L_EXTENDEDPRICE  DOUBLE NOT NULL, -- actually DECIMAL(15,2), but etch uses double
                             L_DISCOUNT    DOUBLE NOT NULL,
                             PRIMARY KEY (L_ORDERKEY, L_LINENUMBER));

CREATE INDEX REGION_idx_q5 ON REGION(R_REGIONKEY, R_NAME);
CREATE INDEX NATION_idx_q5 ON NATION(N_NATIONKEY, N_REGIONKEY, N_NAME);
CREATE INDEX SUPPLIER_idx_q5 ON SUPPLIER(S_SUPPKEY, S_NATIONKEY);
CREATE INDEX ORDERS_idx_q5 ON ORDERS(O_ORDERKEY, O_ORDERDATE, O_CUSTKEY);
CREATE INDEX CUSTOMER_idx_q5 ON CUSTOMER(C_CUSTKEY, C_NATIONKEY);
CREATE INDEX LINEITEM_idx_q5 ON LINEITEM(L_ORDERKEY, L_SUPPKEY, L_EXTENDEDPRICE, L_DISCOUNT);

ATTACH DATABASE 'TPC-H-x0.05.db' AS t;

INSERT INTO region
SELECT r_regionkey, r_name
FROM t.region;

INSERT INTO nation
SELECT n_nationkey, n_regionkey, n_name
FROM t.nation;

INSERT INTO supplier
SELECT s_suppkey, s_nationkey
FROM t.supplier;

INSERT INTO customer
SELECT c_custkey, c_nationkey
FROM t.customer;

INSERT INTO orders
SELECT o_orderkey, o_custkey, o_orderdate
FROM t.orders;

INSERT INTO lineitem
SELECT l_orderkey, l_suppkey, l_linenumber, l_extendedprice, l_discount
FROM t.lineitem;

DETACH DATABASE t;

SELECT page_count * page_size as size
FROM pragma_page_count(), pragma_page_size();
29335552
.timer on

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.052 user 0.051171 sys 0.000174

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.051011 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.050957 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.050 user 0.049905 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.049 user 0.049367 sys 0.000000

.timer off

EXPLAIN QUERY PLAN
select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
QUERY PLAN
|--SCAN lineitem USING COVERING INDEX LINEITEM_idx_q5
|--SEARCH orders USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH customer USING COVERING INDEX CUSTOMER_idx_q5 (C_CUSTKEY=? AND C_NATIONKEY=? AND rowid=?)
|--SEARCH nation USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH region USING INTEGER PRIMARY KEY (rowid=?)
`--USE TEMP B-TREE FOR GROUP BY
cat bench/tpch-q5-sqlite-prep.sql bench/tpch-q5-sqlite.sql | sed 's#TPC-H\.db#TPC-H-x0.05.db#g' | sqlite3/shell

CREATE TABLE REGION  ( R_REGIONKEY  INTEGER NOT NULL,
                            R_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (R_REGIONKEY));
CREATE TABLE NATION  ( N_NATIONKEY  INTEGER NOT NULL,
                            N_REGIONKEY  INTEGER NOT NULL REFERENCES REGION (R_REGIONKEY),
                            N_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (N_NATIONKEY));
CREATE TABLE SUPPLIER ( S_SUPPKEY     INTEGER NOT NULL,
                             S_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (S_SUPPKEY));
CREATE TABLE CUSTOMER ( C_CUSTKEY     INTEGER NOT NULL,
                             C_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (C_CUSTKEY));
CREATE TABLE ORDERS  ( O_ORDERKEY       INTEGER NOT NULL,
                           O_CUSTKEY        INTEGER NOT NULL REFERENCES CUSTOMER (C_CUSTKEY),
                           O_ORDERDATE      DATE NOT NULL,
                           PRIMARY KEY (O_ORDERKEY));
CREATE TABLE LINEITEM ( L_ORDERKEY    INTEGER NOT NULL REFERENCES SUPPLIER (O_ORDERKEY),
                             L_SUPPKEY     INTEGER NOT NULL REFERENCES SUPPLIER (S_SUPPKEY),
                             L_LINENUMBER  INTEGER NOT NULL,
                             L_EXTENDEDPRICE  DOUBLE NOT NULL, -- actually DECIMAL(15,2), but etch uses double
                             L_DISCOUNT    DOUBLE NOT NULL,
                             PRIMARY KEY (L_ORDERKEY, L_LINENUMBER));

CREATE INDEX REGION_idx_q5 ON REGION(R_REGIONKEY, R_NAME);
CREATE INDEX NATION_idx_q5 ON NATION(N_NATIONKEY, N_REGIONKEY, N_NAME);
CREATE INDEX SUPPLIER_idx_q5 ON SUPPLIER(S_SUPPKEY, S_NATIONKEY);
CREATE INDEX ORDERS_idx_q5 ON ORDERS(O_ORDERKEY, O_ORDERDATE, O_CUSTKEY);
CREATE INDEX CUSTOMER_idx_q5 ON CUSTOMER(C_CUSTKEY, C_NATIONKEY);
CREATE INDEX LINEITEM_idx_q5 ON LINEITEM(L_ORDERKEY, L_SUPPKEY, L_EXTENDEDPRICE, L_DISCOUNT);

ATTACH DATABASE 'TPC-H-x0.05.db' AS t;

INSERT INTO region
SELECT r_regionkey, r_name
FROM t.region;

INSERT INTO nation
SELECT n_nationkey, n_regionkey, n_name
FROM t.nation;

INSERT INTO supplier
SELECT s_suppkey, s_nationkey
FROM t.supplier;

INSERT INTO customer
SELECT c_custkey, c_nationkey
FROM t.customer;

INSERT INTO orders
SELECT o_orderkey, o_custkey, o_orderdate
FROM t.orders;

INSERT INTO lineitem
SELECT l_orderkey, l_suppkey, l_linenumber, l_extendedprice, l_discount
FROM t.lineitem;

DETACH DATABASE t;

SELECT page_count * page_size as size
FROM pragma_page_count(), pragma_page_size();
29335552
.timer on

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.050613 sys 0.000021

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.050858 sys 0.000030

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.050 user 0.049812 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.049 user 0.049518 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.050 user 0.049663 sys 0.000000

.timer off

EXPLAIN QUERY PLAN
select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
QUERY PLAN
|--SCAN lineitem USING COVERING INDEX LINEITEM_idx_q5
|--SEARCH orders USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH customer USING COVERING INDEX CUSTOMER_idx_q5 (C_CUSTKEY=? AND C_NATIONKEY=? AND rowid=?)
|--SEARCH nation USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH region USING INTEGER PRIMARY KEY (rowid=?)
`--USE TEMP B-TREE FOR GROUP BY
cat bench/tpch-q5-sqlite-prep.sql bench/tpch-q5-sqlite.sql | sed 's#TPC-H\.db#TPC-H-x0.05.db#g' | sqlite3/shell

CREATE TABLE REGION  ( R_REGIONKEY  INTEGER NOT NULL,
                            R_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (R_REGIONKEY));
CREATE TABLE NATION  ( N_NATIONKEY  INTEGER NOT NULL,
                            N_REGIONKEY  INTEGER NOT NULL REFERENCES REGION (R_REGIONKEY),
                            N_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (N_NATIONKEY));
CREATE TABLE SUPPLIER ( S_SUPPKEY     INTEGER NOT NULL,
                             S_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (S_SUPPKEY));
CREATE TABLE CUSTOMER ( C_CUSTKEY     INTEGER NOT NULL,
                             C_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (C_CUSTKEY));
CREATE TABLE ORDERS  ( O_ORDERKEY       INTEGER NOT NULL,
                           O_CUSTKEY        INTEGER NOT NULL REFERENCES CUSTOMER (C_CUSTKEY),
                           O_ORDERDATE      DATE NOT NULL,
                           PRIMARY KEY (O_ORDERKEY));
CREATE TABLE LINEITEM ( L_ORDERKEY    INTEGER NOT NULL REFERENCES SUPPLIER (O_ORDERKEY),
                             L_SUPPKEY     INTEGER NOT NULL REFERENCES SUPPLIER (S_SUPPKEY),
                             L_LINENUMBER  INTEGER NOT NULL,
                             L_EXTENDEDPRICE  DOUBLE NOT NULL, -- actually DECIMAL(15,2), but etch uses double
                             L_DISCOUNT    DOUBLE NOT NULL,
                             PRIMARY KEY (L_ORDERKEY, L_LINENUMBER));

CREATE INDEX REGION_idx_q5 ON REGION(R_REGIONKEY, R_NAME);
CREATE INDEX NATION_idx_q5 ON NATION(N_NATIONKEY, N_REGIONKEY, N_NAME);
CREATE INDEX SUPPLIER_idx_q5 ON SUPPLIER(S_SUPPKEY, S_NATIONKEY);
CREATE INDEX ORDERS_idx_q5 ON ORDERS(O_ORDERKEY, O_ORDERDATE, O_CUSTKEY);
CREATE INDEX CUSTOMER_idx_q5 ON CUSTOMER(C_CUSTKEY, C_NATIONKEY);
CREATE INDEX LINEITEM_idx_q5 ON LINEITEM(L_ORDERKEY, L_SUPPKEY, L_EXTENDEDPRICE, L_DISCOUNT);

ATTACH DATABASE 'TPC-H-x0.05.db' AS t;

INSERT INTO region
SELECT r_regionkey, r_name
FROM t.region;

INSERT INTO nation
SELECT n_nationkey, n_regionkey, n_name
FROM t.nation;

INSERT INTO supplier
SELECT s_suppkey, s_nationkey
FROM t.supplier;

INSERT INTO customer
SELECT c_custkey, c_nationkey
FROM t.customer;

INSERT INTO orders
SELECT o_orderkey, o_custkey, o_orderdate
FROM t.orders;

INSERT INTO lineitem
SELECT l_orderkey, l_suppkey, l_linenumber, l_extendedprice, l_discount
FROM t.lineitem;

DETACH DATABASE t;

SELECT page_count * page_size as size
FROM pragma_page_count(), pragma_page_size();
29335552
.timer on

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.052 user 0.052246 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.052 user 0.051786 sys 0.000160

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.051016 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.050735 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.050 user 0.050367 sys 0.000000

.timer off

EXPLAIN QUERY PLAN
select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
QUERY PLAN
|--SCAN lineitem USING COVERING INDEX LINEITEM_idx_q5
|--SEARCH orders USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH customer USING COVERING INDEX CUSTOMER_idx_q5 (C_CUSTKEY=? AND C_NATIONKEY=? AND rowid=?)
|--SEARCH nation USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH region USING INTEGER PRIMARY KEY (rowid=?)
`--USE TEMP B-TREE FOR GROUP BY
cat bench/tpch-q5-sqlite-prep.sql bench/tpch-q5-sqlite.sql | sed 's#TPC-H\.db#TPC-H-x0.05.db#g' | sqlite3/shell

CREATE TABLE REGION  ( R_REGIONKEY  INTEGER NOT NULL,
                            R_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (R_REGIONKEY));
CREATE TABLE NATION  ( N_NATIONKEY  INTEGER NOT NULL,
                            N_REGIONKEY  INTEGER NOT NULL REFERENCES REGION (R_REGIONKEY),
                            N_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (N_NATIONKEY));
CREATE TABLE SUPPLIER ( S_SUPPKEY     INTEGER NOT NULL,
                             S_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (S_SUPPKEY));
CREATE TABLE CUSTOMER ( C_CUSTKEY     INTEGER NOT NULL,
                             C_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (C_CUSTKEY));
CREATE TABLE ORDERS  ( O_ORDERKEY       INTEGER NOT NULL,
                           O_CUSTKEY        INTEGER NOT NULL REFERENCES CUSTOMER (C_CUSTKEY),
                           O_ORDERDATE      DATE NOT NULL,
                           PRIMARY KEY (O_ORDERKEY));
CREATE TABLE LINEITEM ( L_ORDERKEY    INTEGER NOT NULL REFERENCES SUPPLIER (O_ORDERKEY),
                             L_SUPPKEY     INTEGER NOT NULL REFERENCES SUPPLIER (S_SUPPKEY),
                             L_LINENUMBER  INTEGER NOT NULL,
                             L_EXTENDEDPRICE  DOUBLE NOT NULL, -- actually DECIMAL(15,2), but etch uses double
                             L_DISCOUNT    DOUBLE NOT NULL,
                             PRIMARY KEY (L_ORDERKEY, L_LINENUMBER));

CREATE INDEX REGION_idx_q5 ON REGION(R_REGIONKEY, R_NAME);
CREATE INDEX NATION_idx_q5 ON NATION(N_NATIONKEY, N_REGIONKEY, N_NAME);
CREATE INDEX SUPPLIER_idx_q5 ON SUPPLIER(S_SUPPKEY, S_NATIONKEY);
CREATE INDEX ORDERS_idx_q5 ON ORDERS(O_ORDERKEY, O_ORDERDATE, O_CUSTKEY);
CREATE INDEX CUSTOMER_idx_q5 ON CUSTOMER(C_CUSTKEY, C_NATIONKEY);
CREATE INDEX LINEITEM_idx_q5 ON LINEITEM(L_ORDERKEY, L_SUPPKEY, L_EXTENDEDPRICE, L_DISCOUNT);

ATTACH DATABASE 'TPC-H-x0.05.db' AS t;

INSERT INTO region
SELECT r_regionkey, r_name
FROM t.region;

INSERT INTO nation
SELECT n_nationkey, n_regionkey, n_name
FROM t.nation;

INSERT INTO supplier
SELECT s_suppkey, s_nationkey
FROM t.supplier;

INSERT INTO customer
SELECT c_custkey, c_nationkey
FROM t.customer;

INSERT INTO orders
SELECT o_orderkey, o_custkey, o_orderdate
FROM t.orders;

INSERT INTO lineitem
SELECT l_orderkey, l_suppkey, l_linenumber, l_extendedprice, l_discount
FROM t.lineitem;

DETACH DATABASE t;

SELECT page_count * page_size as size
FROM pragma_page_count(), pragma_page_size();
29335552
.timer on

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.050655 sys 0.000103

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.050866 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.049 user 0.049348 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.050 user 0.049722 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.050807 sys 0.000000

.timer off

EXPLAIN QUERY PLAN
select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
QUERY PLAN
|--SCAN lineitem USING COVERING INDEX LINEITEM_idx_q5
|--SEARCH orders USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH customer USING COVERING INDEX CUSTOMER_idx_q5 (C_CUSTKEY=? AND C_NATIONKEY=? AND rowid=?)
|--SEARCH nation USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH region USING INTEGER PRIMARY KEY (rowid=?)
`--USE TEMP B-TREE FOR GROUP BY
cat bench/tpch-q5-sqlite-prep.sql bench/tpch-q5-sqlite.sql | sed 's#TPC-H\.db#TPC-H-x0.05.db#g' | sqlite3/shell

CREATE TABLE REGION  ( R_REGIONKEY  INTEGER NOT NULL,
                            R_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (R_REGIONKEY));
CREATE TABLE NATION  ( N_NATIONKEY  INTEGER NOT NULL,
                            N_REGIONKEY  INTEGER NOT NULL REFERENCES REGION (R_REGIONKEY),
                            N_NAME       CHAR(25) NOT NULL,
                            PRIMARY KEY (N_NATIONKEY));
CREATE TABLE SUPPLIER ( S_SUPPKEY     INTEGER NOT NULL,
                             S_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (S_SUPPKEY));
CREATE TABLE CUSTOMER ( C_CUSTKEY     INTEGER NOT NULL,
                             C_NATIONKEY   INTEGER NOT NULL REFERENCES NATION (N_NATIONKEY),
                             PRIMARY KEY (C_CUSTKEY));
CREATE TABLE ORDERS  ( O_ORDERKEY       INTEGER NOT NULL,
                           O_CUSTKEY        INTEGER NOT NULL REFERENCES CUSTOMER (C_CUSTKEY),
                           O_ORDERDATE      DATE NOT NULL,
                           PRIMARY KEY (O_ORDERKEY));
CREATE TABLE LINEITEM ( L_ORDERKEY    INTEGER NOT NULL REFERENCES SUPPLIER (O_ORDERKEY),
                             L_SUPPKEY     INTEGER NOT NULL REFERENCES SUPPLIER (S_SUPPKEY),
                             L_LINENUMBER  INTEGER NOT NULL,
                             L_EXTENDEDPRICE  DOUBLE NOT NULL, -- actually DECIMAL(15,2), but etch uses double
                             L_DISCOUNT    DOUBLE NOT NULL,
                             PRIMARY KEY (L_ORDERKEY, L_LINENUMBER));

CREATE INDEX REGION_idx_q5 ON REGION(R_REGIONKEY, R_NAME);
CREATE INDEX NATION_idx_q5 ON NATION(N_NATIONKEY, N_REGIONKEY, N_NAME);
CREATE INDEX SUPPLIER_idx_q5 ON SUPPLIER(S_SUPPKEY, S_NATIONKEY);
CREATE INDEX ORDERS_idx_q5 ON ORDERS(O_ORDERKEY, O_ORDERDATE, O_CUSTKEY);
CREATE INDEX CUSTOMER_idx_q5 ON CUSTOMER(C_CUSTKEY, C_NATIONKEY);
CREATE INDEX LINEITEM_idx_q5 ON LINEITEM(L_ORDERKEY, L_SUPPKEY, L_EXTENDEDPRICE, L_DISCOUNT);

ATTACH DATABASE 'TPC-H-x0.05.db' AS t;

INSERT INTO region
SELECT r_regionkey, r_name
FROM t.region;

INSERT INTO nation
SELECT n_nationkey, n_regionkey, n_name
FROM t.nation;

INSERT INTO supplier
SELECT s_suppkey, s_nationkey
FROM t.supplier;

INSERT INTO customer
SELECT c_custkey, c_nationkey
FROM t.customer;

INSERT INTO orders
SELECT o_orderkey, o_custkey, o_orderdate
FROM t.orders;

INSERT INTO lineitem
SELECT l_orderkey, l_suppkey, l_linenumber, l_extendedprice, l_discount
FROM t.lineitem;

DETACH DATABASE t;

SELECT page_count * page_size as size
FROM pragma_page_count(), pragma_page_size();
29335552
.timer on

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.052 user 0.051470 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.051327 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.051 user 0.050460 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.050 user 0.050029 sys 0.000000

select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
CHINA|2789340.1654
INDIA|2777475.0154
INDONESIA|3089951.1887
JAPAN|2761120.3856
VIETNAM|2681397.1853
Run Time: real 0.050 user 0.050008 sys 0.000000

.timer off

EXPLAIN QUERY PLAN
select
 n_name,
 sum(l_extendedprice * (1 - l_discount)) as revenue
from
  customer,
  orders,
  lineitem,
  supplier,
  nation,
  region
where
  c_custkey = o_custkey
  and l_orderkey = o_orderkey
  and l_suppkey = s_suppkey
  and c_nationkey = s_nationkey
  and s_nationkey = n_nationkey
  and n_regionkey = r_regionkey
  and r_name = 'ASIA'
  and o_orderdate >= '1994-01-01'
  and o_orderdate < '1995-01-01'
group by
 n_name;
QUERY PLAN
|--SCAN lineitem USING COVERING INDEX LINEITEM_idx_q5
|--SEARCH orders USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH customer USING COVERING INDEX CUSTOMER_idx_q5 (C_CUSTKEY=? AND C_NATIONKEY=? AND rowid=?)
|--SEARCH nation USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH region USING INTEGER PRIMARY KEY (rowid=?)
`--USE TEMP B-TREE FOR GROUP BY
